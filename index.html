<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ã¿ã‚“ãªã§è±†è…å®ˆã‚Š</title>
    <style>
        /* ã‚«ã‚ªã‚¹ãªãƒ‡ã‚¶ã‚¤ãƒ³ */
        body {
            margin: 0;
            font-family: 'Comic Sans MS', sans-serif;
            background-color: #ffebcd; /* è±†è…è‰² */
            text-align: center;
            overflow: hidden;
            touch-action: none; /* ã‚¹ãƒãƒ›ã§ã®æ“ä½œç„¡åŠ¹åŒ– */
        }
        #game-screen, #result-screen { display: none; }
        
        .btn {
            background: #ff4500;
            color: white;
            border: none;
            padding: 15px 30px;
            font-size: 20px;
            border-radius: 10px;
            margin: 10px;
            cursor: pointer;
            box-shadow: 0 5px #b22222;
        }
        .btn:active { box-shadow: 0 2px #b22222; transform: translateY(3px); }

        #tofu {
            width: 200px;
            height: 200px;
            margin-top: 50px;
            transition: transform 0.1s;
        }
        /* ææ€–ã®ç‚¹æ»…ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
        .flash {
            animation: flashing 0.2s infinite;
        }
        @keyframes flashing {
            0% { background-color: red; }
            50% { background-color: yellow; }
            100% { background-color: black; }
        }
    </style>
</head>
<body>

    <div id="lobby-screen">
        <h1>ğŸ›¡ï¸ ã¿ã‚“ãªã§è±†è…å®ˆã‚Š</h1>
        <p>éŸ³é‡ã‚’MAXã«ã—ã¦ãã ã•ã„ã€‚<br>ç¤¾ä¼šçš„ã«æ­»ã«ã¾ã™ã€‚</p>
        <div id="room-info"></div>
        <input type="text" id="room-code-input" placeholder="éƒ¨å±‹ã‚³ãƒ¼ãƒ‰6æ¡" style="padding:10px; font-size:18px;">
        <br>
        <button class="btn" onclick="createRoom()">éƒ¨å±‹ã‚’ä½œã‚‹</button>
        <button class="btn" onclick="joinRoom()">éƒ¨å±‹ã«å…¥ã‚‹</button>
        <br><br>
        <button class="btn" id="start-btn" style="display:none; background:gold; color:black;" onclick="startGame()">å…¨å“¡æƒã£ãŸï¼é–‹å§‹ï¼</button>
    </div>

    <div id="game-screen">
        <h2 style="color:red;">çµ¶å¯¾ã«æŒ‡ã‚’é›¢ã™ãª...</h2>
        <img id="tofu" src="https://1.bp.blogspot.com/-m5W7M4kH4vI/U0U7u6s-VLI/AAAAAAAAe_Y/u2LhN9Y9C9I/s800/food_tofu.png">
    </div>

    <div id="result-screen">
        <h1 style="font-size: 50px;">â˜ ï¸ GAME OVER â˜ ï¸</h1>
        <h2 id="traitor-name">æˆ¦çŠ¯ï¼š???</h2>
        <p>ãŒè£åˆ‡ã‚Šã¾ã—ãŸ</p>
        <button class="btn" onclick="location.reload()">ã‚‚ã†ä¸€åº¦ã‚„ã‚‹</button>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, onSnapshot, arrayUnion } 
        from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // â˜…ã“ã“ã«Firebaseã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã®è¨­å®šã‚’ã‚³ãƒ”ãƒšã›ã‚ˆâ˜…
    const firebaseConfig = {
  apiKey: "AIzaSyDY8AWBkOS5H8ynYkODpogLl7SYoRF2JvY",
  authDomain: "tofu1-66cb7.firebaseapp.com",
  projectId: "tofu1-66cb7",
  storageBucket: "tofu1-66cb7.firebasestorage.app",
  messagingSenderId: "96663536524",
  appId: "1:96663536524:web:0de179a9ed218268598ca9",
  measurementId: "G-68E9Q4Y7FR"
};

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        let roomCode = "";
        let myName = "User" + Math.floor(Math.random() * 1000);
        let isTouching = false;
        
        // åŠ¹æœéŸ³ï¼ˆãƒ•ãƒªãƒ¼ç´ æã®URLãªã©ã‚’å…¥ã‚Œã‚‹ï¼‰
        const screamAudio = new Audio('https://www.soundjay.com/human/sounds/scream-01.mp3'); 

        // éƒ¨å±‹ã‚’ä½œã‚‹
        window.createRoom = async () => {
            roomCode = Math.floor(100000 + Math.random() * 900000).toString();
            await setDoc(doc(db, "rooms", roomCode), {
                status: "waiting",
                members: [myName],
                traitor: ""
            });
            startListening();
        };

        // éƒ¨å±‹ã«å…¥ã‚‹
        window.joinRoom = async () => {
            roomCode = document.getElementById("room-code-input").value;
            if(!roomCode) return alert("ã‚³ãƒ¼ãƒ‰ã‚’å…¥ã‚Œã¦ã­");
            await updateDoc(doc(db, "rooms", roomCode), {
                members: arrayUnion(myName)
            });
            startListening();
        };

        // ç›£è¦–é–‹å§‹
        function startListening() {
            document.getElementById("lobby-screen").innerHTML = `<h2>éƒ¨å±‹ã‚³ãƒ¼ãƒ‰: ${roomCode}</h2><p>å¾…æ©Ÿä¸­...</p>`;
            
            onSnapshot(doc(db, "rooms", roomCode), (doc) => {
                const data = doc.data();
                if(!data) return;

                // ãƒ¡ãƒ³ãƒãƒ¼æ›´æ–°
                if(data.status === "waiting") {
                     // è‡ªåˆ†ãŒãƒ›ã‚¹ãƒˆãªã‚‰é–‹å§‹ãƒœã‚¿ãƒ³å‡ºã™ã¨ã‹ã®å‡¦ç†ï¼ˆçœç•¥ï¼‰
                     if(document.getElementById("start-btn")) document.getElementById("start-btn").style.display = "block";
                }

                // ã‚²ãƒ¼ãƒ é–‹å§‹
                if(data.status === "playing") {
                    document.getElementById("lobby-screen").style.display = "none";
                    document.getElementById("game-screen").style.display = "block";
                    // ã“ã“ã§éŸ³æ¥½å†ç”Ÿè¨±å¯ã®ãŸã‚ã®ãƒ€ãƒŸãƒ¼å†ç”Ÿã‚’å…¥ã‚Œã‚‹
                    screamAudio.play(); 
                    screamAudio.pause();
                }

                // æ­»äº¡
                if(data.status === "dead") {
                    document.body.classList.add("flash"); // èƒŒæ™¯ç‚¹æ»…
                    screamAudio.play(); // çµ¶å«
                    document.getElementById("game-screen").style.display = "none";
                    document.getElementById("result-screen").style.display = "block";
                    document.getElementById("traitor-name").innerText = "æˆ¦çŠ¯ï¼š" + data.traitor;
                }
            });
        }

        // ã‚²ãƒ¼ãƒ é–‹å§‹ãƒˆãƒªã‚¬ãƒ¼
        window.startGame = async () => {
            await updateDoc(doc(db, "rooms", roomCode), { status: "playing" });
        };

        // ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆï¼ˆWebç”¨ï¼‰
        const tofu = document.getElementById("tofu");
        
        // è§¦ã‚ŒãŸæ™‚
        tofu.addEventListener("touchstart", (e) => {
            e.preventDefault();
            tofu.style.transform = "scale(0.9)";
            isTouching = true;
        }, {passive: false});

        // é›¢ã—ãŸæ™‚ï¼ˆã‚¹ãƒãƒ›ï¼‰
        tofu.addEventListener("touchend", async (e) => {
            if(isTouching) {
                await updateDoc(doc(db, "rooms", roomCode), { 
                    status: "dead",
                    traitor: myName
                });
            }
        });

        // ãƒã‚¦ã‚¹ï¼ˆPCãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰
        tofu.addEventListener("mousedown", () => {
            tofu.style.transform = "scale(0.9)";
            isTouching = true;
        });
        tofu.addEventListener("mouseup", async () => {
            if(isTouching) {
                await updateDoc(doc(db, "rooms", roomCode), { 
                    status: "dead",
                    traitor: myName
                });
            }
        });
    </script>
</body>
</html>